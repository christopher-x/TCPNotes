# 第二章 TC/IP的工作方式

## 2.1 TCP/IP协议系统  

**简要协作系统职责:** 像TCP/IP这样的协议系统必须负责完成以下任务  

* 把消息分解为可管理的数据块，并且这些数据块能够有效的通过传输介质    

* 与网络适配器硬件连接  

* 寻址，即发送端计算机必须能够定位到接收数据的计算机，接收计算机必须能够识别自己要接收的数据  

* 将数据路由到目的的计算机所在的子网，即使源子网和目的子网分处不同的物理网络  

* 执行错误控制、流量控制和确认：对可靠的通信而言，发送和接收计算机必须能够发现并纠正传输错误，并控制数据流  

* 从应用程序接收数据并传输到网络  

* 从网络接收数据并传输到应用程序  

为了实现上述功能，TCP/IP的创建者使用模块化的设计。TCP/IP协议系统被分为不同的组件，这些组件从理论上来说能够相互独立地实现自己的功能。每个组件分别负责通信过程中的一个步骤  

模块化的好处在于可以让厂商方便地根据特定硬件和操作系统对协议软件进行修改  

**例如**网络访问层包含了屋里网络规范和设计相关的功能，由于TCP/IP的模块化设计，像Microsoft这样的厂商在使用光纤网络时就不必重新构建一个全新的TCP/IP软件，上层不会受到网络物理结构变化的影响，只要修改网络访问层即可  

TCP/IP协议系统划分为不同层次的组件，分别实现特定的功能  

不同的模型有着不同的分层，本次使用的为四层模型  

**应用层**&rarr;**传输层**&rarr;**网际层**&rarr;**网络访问层**  

* 网络访问层，提供了与物理网络连接的接口，针对传输介质设置数据的格式，根据硬件的物理地址实现数据的寻址，对数据在物理网络中的传递提供错误控制  
* 网际层，提供独立于硬件的逻辑寻址，让数据在具有不同物理结构的子网之间传递，提供路由功能来降低流量，支持网间（internetwork）的数据传递，实现物理地址（网络访问层使用的地址）与逻辑地址的转换  
* 传输层，为网络提供了流量控制，错误控制和确认服务，充当网络应用程序的接口  
* 应用层，为网络排错，文件传输，远程控制和Internet操作提供了应用程序，还支持应用编程接口（API），当TCP/IP协议软件准备通过网络传递数据时，发送端计算机上的每一层协议都在数据上添加层信息，对应于接收端计算机上相应的层，这个过程也叫做封装，在接收端当数据在协议栈里传递时，这些报头信息被逐步去除  

## 2.2 TCP/IP和OSI模型  

网络业界针对网络协议体系有一个标准的七层模型，称为开放系统互连（OSI）模型，这是ISO（国际标准化组织）为了标准化网络协议系统所作出的规范，旨在提高网络互联性，并且方便软件开发人员以一种开放方式来使用协议标准  

TCP/IP并没有完全遵守OSI模型，因为当OSI模型问世时，TCP/IP已经在开发过程中了，但是这两种模型的确具有类似的目标，而且他们的设计者时间有足够的交互，所以它们具有一定的兼容性，OSI模型对于协议实现的开发与发展具有非常大的影响力  

OSI将**应用层，表示层，会话层**都划入了**TCP/IP**中的**应用层**  

传输层和网络层TCP/IP以及OSI划分一致  

OSI中的**数据链路层，物理层**都划入了**TCP/IP**中的**网络访问层**  

**OSI模型的七层为：**

* 物理层，将数据转换为传输介质上的电子流或模拟脉冲，并且监视数据的传输  
* 数据链路层，提供与网络适配器相连的接口，维护子网的逻辑链接  
* 网络层，支持逻辑寻址与路由选择  
* 传输层，为网络提供错误控制和数据流控制  
* 会话层，在计算机的通信应用程序之间建立会话  
* 表示层，将数据转换为标准格式，管理数据加密与压缩  
* 应用层，为应用程序提供网络接口，支持文件传输，通信等功能的网络应用  

**注意：TCP/IP模型与OSI模型都是标准，而不是实现**，且具体实现都没有严格遵守四层模型或七层模型  

在重要的传输层和网际层（OSI中称为网络层）OSI和TCP/IP模型是最相似的，这些层包含了组件最能体现网络协议之间的区别，TCP/IP协议簇的名称就来自于TCP（一个传输层协议）和IP（一个网际层/网络层协议）  

## 2.3 数据包  

关于TCP/IP协议栈需要强调的是，其中每一层都在整个通信过程中扮演一定的角色，并调用必要的服务来完成相应的功能，在数据发送过程中，流程为从堆栈的上到下，每一层都把相关的信息（称为报头）捆绑到实际的数据上，包含报头信息和数据的数据包就作为下一层的数据，再次被添加报头信息和重新打包，当数据到达目的计算机时，接收过程恰恰相反，数据从下到上经过协议栈的过程中，每一层都解开相应的报头并使用其中的信息  

可以想象数据发送时就像俄罗斯套娃，没最里面的娃娃被套在稍大一点的娃娃中，以此类推，在接收端，当数据从下至上经过协议栈时，数据包被逐渐解包，接收端的网际层会使用网际层的头信息，传输层会使用传输层的报头信息，每一层，数据包的格式都能向对应的层提供必要的信息，由于每一层分别具有不同的功能，所以每一层数据包的形式也是千差万别  

**数据包在每一层具有不同的形式和名称**  

* 应用层生成的数据包被称为消息  
* 传输层生成的数据封装了应用层的消息，如果它来自于传输层的TCP协议，就被称为分段；如果来自传输层的UDP协议，则被称为数据报  
* 在网际层的数据包封装了传输层的片段，被称为数据报  
* 在网络访问层的数据包封装了数据包（而且可能对其进行再分解），被称为帧，帧呗访问层里的最低子层转化为比特流  

## 2.4 TCP/IP网络概述  

实际上，虽然TCP/IP协议簇里每个协议都有自己的作用，但TCP/IP协议簇的主要功能是可以通过几个最重要的协议来完成的  

基本场景如下：  

1.数据从工作与应用层的协议，网络服务或应用编程接口（API）通过TCP或者UDP端口传递到两个传输层协议（TCP或UDP）中的一个，程序可以根据需要通过TCP或UDP访问网络  

* TCP是面向连接的协议，与无连接的协议相比，面向连接的协议提供更复杂的流量控制和错误控制。TCP能够确保数据的发送质量，比UDP更可靠，但由于需要额外的错误检测和流量控制，因此比UDP的速度慢  
* UDP是个无连接的协议，比TCP快，但是不可靠，它把错误控制的责任推给了应用  

2.数据分段传递到网际层，IP协议在此提供逻辑寻址信息，并把数据封装为数据报  

3.IP数据报进入网络访问层，传递到与物理网络相连接的软件组件。网络访问层创建一个或多个数据帧，从而进入到物理网络。像以太网这样的局域网系统中，帧可能包含从表哥里获得的物理地址信息，而这些表格是由网际层的ARP维护的（ARP是地址解析协议，把IP地址转换为物理地址）  

4.数据帧被转化为比特流，通过网络介质进行传输  

## 2.5 小结  

本章介绍了TCP/IP协议栈的分层结构及其之间的相互关系，还讲解了经典的TCP/IP模型与OSI七层模型之间的关系，在协议栈的每一层中，数据都进行了封装，添加了接收端相应层所需的信息。本章讨论了每个协议层封装报头信息的过程，概述了每一层数据包的名称  

## 2.6 问与答  

问：TCP/IP模块化设计的主要优点是什么？  

**答：** 由于TCP/IP的模块化设计，TCP/IP协议栈能够方便地进行需改来适应特定的硬件和操作环境，将网络软件划分为具体的，设计良好的组件，有助于开发人员更容易得编写出于协议系统进行交互的程序  

问：网络访问层提供了什么功能？  

**答：**  网络访问层提供了与特定物理网络相关的服务，包括基于特定传输介质（比如以太网电缆）准备，发送和接收数据帧  

问：OSI模型的那一层对应与TCP/IP的网际层？  

**答：** OSI的网络层对应TCP/IP的网际层  

问：为什么要在TCP/IP协议栈的每一层封装报头信息？  

**答：** 因为接收设备上每个协议层需要不同的信息来处理收到的数据，所以发送设备上的每一层就封装相应的报头信息。  

## 2.7 测验  

### 2.7.1 问题  

1.OSI的那两层对应TCP/IP的网络接入层？  

**答：数据链路层，物理层**  

2.TCP/IP的哪一层负责将数据从一台计算机路由到另外一台计算机？  

**答：网络层**  

3.与TCP相比，UDP的优势和劣势分别是什么？  

**答：UDP不需要建立连接之后再进行传输，所以相比TCP来说UDP的传输速度更快，但是UDP的可靠性较差，且会在发送时丢包，因为并不可靠**  

4.哪一层处理帧？  

**答：网络访问层**  

5.每一层封装数据的真实含义是什么？  

**答：因为在接收设备上每个协议层需要不同的信息来处理收到的数据，所以在数据向下传输到下一层之前，会先在数据中附加一个特定层的报头信息**   

### 2.7.2 练习  

1.列举TCP/IP协议栈中每一层所执行的功能  

**答：网络访问层，提供物理硬件的接口**  

**网际层，为数据报提供逻辑寻址和路由**  

**传输层，提供错误检测，流量控制和确认服务**  

**应用层，提供网络排错设施，文件传输，远程控制和其他基于网络的工作，它还提供应用程序的网络API**  

2.列出处理数据报的层  

**答：IP和传输层处理数据报**  

3.如何修改TCP/IP，才能使用新发明的网络类型？  

**答：只有网络访问层需要修改，栈的其他部分保持不变**   

4.为什么说TCP/IP是可靠的协议？  

**答：TCP传输控制协议，提供的是面向连接，可靠的字节流服务，当客户端和服务器进行交换数据之前，必须现在双方之间建立一个TCP连接，之后才能传输数据，TCP提供超时重发，丢弃重复数据，检验数据，流量控制等功能，保证数据能从一端到另一端**  

## 2.8 关键术语  

**地址解析协议** 将逻辑IP地址解析为物理地址的协议  

**应用层** TCP/IP栈中的一层，它支持网络应用，提供与本地操作环境相交互的接口  

**数据报** 从网际层传输到网络访问层的数据报，或是从传输层UDP传递到网际层的数据包  

**帧** 在网络访问层创建的数据包  

**报头** 在协议栈每一层附加到数据上的协议信息  

**网际层** TCP/IP栈中的一层，提供逻辑寻址和路由选择  

**IP** 网际层协议，提供逻辑寻址和路由选择功能  

**消息** 在TCP/IP网络中，消息是从应用层传递到传输层的数据包，该术语通常也用于描述从网络上一个实体传递到另一个实体的信息，它并不总是值应用层数据包  

**网络访问层** TCP/IP协议中的一层，提供与物理网络连接的接口  

**分段** 从传出层的TCP传递到网际层的数据包  

**TCP（传输控制协议）** 传输层中一个可靠的，面向连接的协议  

**传输层** TCP/IP协议栈中的一层，提供错误控制和确认功能，并充当网络应用程序的接口  

**UDP（用户数据报协议）** 传输层中一个不可靠的，无连接的协议  

