# 第三章 网络访问层

## 基本概念：

TCP/IP协议栈的最底层是网络访问层，其中包含的服务与规范提供并管理着对网络硬件的访问。  

## 3.1 协议和硬件

网络访问层是最不统一的TCP/IP层，它管理为物理网络准备数据所必须的服务与功能，包括：  

* 与计算机网络适配的连接  
* 根据合适的访问方式调整数据传输  
* 把数据转化为电子流或模拟脉冲的形式，以在传输介质上进行传输  
* 对接收到的数据进行错误检查  
* 给发送的数据添加错误检查信息，从而让接收端计算机能够对数据进行错误检查  

在数据到达目标计算机时，对发送数据所做的任何格式化操作都必须能以相反方式恢复  

逻辑IP地址只存在于软件之中，协议系统需要其他服务在特定局域网系统把数据传递到目的计算机的网络适配器，这些服务正式由网络访问层所提供的  

**注：** 是否应该讨论网络访问层  

由于网络访问层的多样性，复杂性和透明性，有些作者在讨论TCP/IP时完全没有涉及它，就好像协议栈是基于网际层下面的局域网驱动程序一样，这种话看法有一定的价值，但网络访问层实际上是TCP/IPde一部分，没有它就不可能完整的讨厌网络通信过程  

## 3.2 网络访问层与OSI模型  

TCP/IP是独立于OSI七层网络模型的，但OSI模型经常作为一种通用框架来理解各种协议系统。在讨论网络访问层时，OSI术语和概念是通用的，因为OSI模型对网络访问进一步细分，因此更好的揭示着一层里的运行情况  

TCP/IP网络访问层大致对应OSI的物理层和数据链路层，OSI的物理层负责把数据帧转化为适合于传输介质的比特流，也就是说，OSI物理层管理和同步实际上传的电子或模拟脉冲，在接收端，物理层把这些脉冲重新组合为数据帧  

OSI数据链路层执行两个独立的任务，相应的划分为两个子层  

* 介质访问控制（MAC）这个子层提供与网络适配器连接的接口，实际上网络适配器驱动程序通常被称为MAC驱动，而网卡在工厂固化的硬件地址通常被称为MAC地址  
* 逻辑链路控制（LLC）这个子层对经过子网传递的帧进行错误检查，并且管理子网上通信设备之间的链路  

**注意：** NDIS和ODI  

在实际的网络协议实现中，网络驱动程序接口规范（NDIS）和开放数据链路接口（ODI）规范的存在进一步复杂了TCP/IP层与OSI系统之间的区别，NDIS（Microsoft和3Com公司开发）和ODI（由Apple和Novell开发）的设计目的在于让单个协议栈（比如TCP/IP）使用多个网络适配器，并让单个网络适配器使用多个上层协议，这样可以让上层协议彻底独立于网络访问系统，从而为网络增加了很强的功能，但同时也增加了复杂性，也让系统地介绍软件组件在低层如何交互变得更加困难。  

## 3.3 网络体系  

局域网并不是一种协议层术语，而是代表局域网体系或网络体系（有时网络体系也被称为局域网类型或局域网拓扑）。网络体系（比如以太网）具有一系列的规范来管理介质访问、物理寻址、计算机与传输介质的交互。在决定网络体系时，实际上是在决定如何设计网络访问层  

网络体系包含对物理网络的定义，以及该物理网络上定义的通信规范。通信细节基于物理细节，所以这些规范通常以一个完整的包出现，这些规范包含以下几个方面。  

* 访问方法：访问方法是定义了计算机如何共享传输介质的一组规则，为了避免数据冲突，计算机在传输数据时必须遵守这些规则  
* 数据帧格式：来自于网际层的IP级别的数据报以预定义的格式封装为数据帧，封装在包头中的数据必须提供在物理网络上花你的数据所需要的信息  
* 布线类型：网络所使用的线缆类型对于其他设计参数具有一定的影响，比如适配器传递的比特流的电子特性  
* 布线规则：协议、线缆类型和传输的电子特性影响着线缆的最大和最小长度、电缆连接器的规范  

像线缆类型和连接器类型这样的细节问题并不是由网络访问层直接负责的，但为了设计网络访问层的软件组件，开发人员必须假定物理网络具有特定的性质，因此网络访问层的软件必须伴随着特定的硬件设计。  

网络访问层以上的协议层不必关心硬件设计的问题。TCP/IP协议栈的设计保证了与硬件交互相关的细节都发生在网络访问层，使得TCP/IP能够工作与多种不同的传输介质  

网络访问层包括如下一些体系  

* IEEE 802.3（以太网）：在大多数办公室和家庭使用的基于线缆的网络  
* IEEE 802.11（无线网络）：在办公室，家庭和咖啡厅使用的无线网络技术  
* IEEE 802.16（WiMAX）：用于移动通信长距离无线连接的技术  
* 点对点协议（PPP）：Modem通过电话线进行连接的技术  

TCP/IP还支持其他一些网络体系，协议栈的模块化特性使得网络访问层里与硬件打交到的软件组件能够为和硬件无关操作的上层提供接口  

由于网络访问层封装了传输介质的细节，因此协议栈的上层可以独立于硬件进行操作  

## 3.4 物理寻址  

网络访问层需要把逻辑IP地址（通过协议软件来配置）与网络适配器的固定物理地址相关联，物理地址通常也被称为MAC地址，因为在OSI模型中物理寻址是由介质访问控制（MAC）子层负责的。由于物理寻址系统是封装在网络访问层中的，所以地址可以根据网络体系规范采用不同的形式  

在以太网中，物理地址通常是由工厂固态在网络硬件中的，尽管有些现代的网络提供了可编程的物理地址，但无论是什么情况，硬件通常都具有预制的物理地址  

经过局域网传递的数据帧必须使用物理地址来表示源适配器和目的适配器，但冗长的物理地址（以太网使用48比特地址）的可用性非常差。但是在较高的协议层对物理地址进行编码又会破坏TCP/IP模块带来的灵活性，因为后者要求上层协议与物理细节无关，TCP/IP使用地址解析协议（ARP）和逆向地址解析协议（RARP）把IP地址关联到网络适配器的物理地址。ARP和RARP为用户提供的逻辑IP地址与局域网上使用的硬件地址建立了一个对应关系  

**注意：** 以太网软件使用的地址并不是逻辑IP地址，但这个地址在网际层的接口上与IP地址有映射关系  

## 3.5 以太网  

以太网使用称为载波侦听多路访问/冲突检测（CSMA/CD）的方法，来判断计算机何时可以把数据发送到访问介质。通过使用CSMA/CD，所有计算机都监视传输介质的状态，在传输之前等待线路空闲。如果两台计算机尝试同时发送数据，就会发生冲突，计算机就会通知发送，等待一个随机的时间间隔，然后在此尝试发送  

CSMA/CD可以比喻为一个由很多人的房间，如果有人想剪花，首先要确认目前是否有人在讲话（这就是载波侦听）如果两个人同时开始讲话，他们都会发现这个问题，从而停止讲话，等待一段时间再开始讲话（这就是冲突检测）  

## 3.6 剖析以太网帧  

网络访问层的软件从网际层接收数据报，把它转化符合物理网络规范的形式。在以太网中，网络访问层的软件必须把数据转化成能够通过网络适配器硬件进行传输的形式  

当以太网软件从网际层接收到数据报之后，执行以下操作  

1.根据需要把网际层的数据分解为较小的块，以符合以太网帧数据段的要求，以太网帧的整体大小必须在64字节与1518字节之间（不包含前导码）。有些系统支持更大的帧，最大可以到9000字节。这种大型帧可以改善效率，但存在着兼容性的问题，而且并没有得到广泛支持。  

2.把数据块打包称成帧，每一帧都包含数据及其他信息，这些信息是以太网适配器处理帧所需要的。IEEE 802.3以太网帧包含以下内容  

* 前导码：表示帧起始的一系列比特（一共8字节，最后一个字节是帧起始符）  

* 目标地址：接收帧的网络适配器的6字节（48比特）物理地址  

* 源地址：发送帧的网络适配器的6字节（48比特）物理地址  

* 可选的VLAN标记：这个可选的16比特字段在802.1q标准中有讲解，其目的是允许多个虚拟LAN通过同一个网络交换机运行  

* 长度：两个字节，表示数据段的长度。  

* 数据：帧中传输的数据  

* 帧校验序列（FCS）：帧的4字节（32比特）校验和FCS是检验数据传输的常见方式。发送方计算帧的循环冗余码校验（CRC）值，把这个值写到帧里。接收方计算机重新计算CRC，与FCS字段的值进行比较，如果两个值不相同，就表示传输过程中发生了数据丢失或改变。这时就需要重新传输这一帧  

3.把数据帧传递给对应的OSI模型物理层的底层组件，后者把帧转换为比特流，并且通过传输介质发送出去，以太网上其他网络适配器接收到这个帧，检查其中的目的地址。如果目的地址与网络适配器的地址相匹配，适配器软件就会处理接收到的帧，把数据传递给协议栈中较高的层  

## 3.7 小结  

网络访问层是TCP/IP协议栈中变化最多，最复杂的一层，网络访问层定义了与网络硬件通信和访问传输介质的过程。局域网体系有很多种，导致了网络访问层有很多不同的规范  

以太网技术的应用广泛，但连接计算机的计算还有很多，任何连网技术都需要以某种方式使用物理网络，因此，任何TCP/IP技术必须具有一个网络访问层  

## 3.8 问与答  

问：网络访问层定义了什么类型的服务？  

**答：**网络访问层包含了管理物理网络访问过程的服务和规范  

问：OSI模型中的哪一层对应TCP/IP网络访问层？  

**答：** 网络访问层大致对应于OSI模型里的数据链路层和物理层  

问：最常见的局域网体系是什么？  

**答：**虽然无线局域网技术越来越流行，但最常用的局域网体系仍然是以太网。  

问：什么是CSMA/CD？  

**答：** CSMA/CD是“载波侦听多路访问/冲突检测“的英文缩写，是以太网使用的访问方法。在使用这种方法时，网络上的计算机在传输数据之前先等待一下，如果两台计算机尝试同时发送数据，它们都会停止发送，等待一个随机的时间间隔，再尝试发送。  

## 3.9 测验  

### 3.9.1问题  

1.什么是CRC？  

**答：循环冗余校验，用来检验数据帧中的数据没有被破坏的校验和**  

2.在以太网中，什么是冲突检测？  

**答：当以太网上的两个节点在统一时刻开始传输数据，会发生冲突，当节点检测到有冲突发生，就会报告发生了冲突检测**  

3.以太网物理地址多大？  

**答：48位（6个字节）**  

4.NDIS和ODI的用途是什么？  

**答：NDIS网络驱动程序接口规范，ODI开放程序链路接口。目的在于让单个协议栈（比如TCP/IP）使用多个网络适配器，并让单个网络适配器使用多个上层协议**  

5.ARP具有什么功能？  

**答：把IP地址关联到网络适配器的物理地址上**  

### 3.9.2 练习  

1.列举将物理地址与IP地址关联起来的两种协议  

**答：ARP，RARP**  

2.列举至少4种网络体系  

**答：以太网、IEEE 802.11（Wi-Fi）、IEEE 802.16（WiMax）和电话线拨号是4种常见的网络体系**  

3.解析OSI介质访问控制子层和逻辑链路控制子层所执行的功能  

**答：MAC地址提供了网络适配器的接口。逻辑链路控制层提供了帧错误检测功能，并可以管理子网种网络节点之间的链路**  

## 3.10 关键术语  

复习下列关键术语：  

* 访问方法：控制对传输介质访问的过程  
* CRC（循环冗余码校验）：一种计算校验和的方式，用于检验数据帧中内容的正确性  
* CSMA/CD：以太网使用的网络访问方法  
* 数据链路层：OSI模型的第二层  
* 以太网：一种非常流行的局域网体系，使用CSMA/CD网络访问方法  
* 帧校验序列（FCS）：以太网帧中的字段，包含一个基于CRC的校验值，用来校验数据  
* 逻辑链路控制子层：OSI数据链路层的一个子层，负责检验错误和管理子网设备之间的链路  
* 介质访问控制子层：OSI数据链路层的一个子层，负责与网络适配器通信  
* 网络体系：关于物理网络的完整规范，包括访问数据，数据帧，网络布线的规范  
* 物理地址（或MAC地址）：识别网路网络中网络适配器的地址，在以太网中，物理地址通常由生产厂商分配，但是现代的一些网络适配器也允许对物理地址进行配置  
* 物理层：OSI模型第一层，负责把数据帧转化为比特流以适合传输介质的要求  
* 前导码：一系列比特，表示数据帧传输的开始  